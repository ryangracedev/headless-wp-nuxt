#!/usr/bin/env node

/**
 * Generate WordPress Blocks CSS from Tailwind Config
 * 
 * This script reads your tailwind.config.js and generates
 * a wordpress-blocks.css file with all the block styles
 * using your custom theme colors, fonts, and spacing.
 * 
 * Usage: node scripts/generate-wp-blocks-css.js
 */

import { readFileSync, writeFileSync, existsSync } from 'fs';
import { resolve, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Read the tailwind config
const tailwindConfigPath = resolve(__dirname, '../tailwind.config.js');
const themeJsonPath = resolve(__dirname, '../../shared/theme.json');
console.log('üìñ Reading Tailwind config from:', tailwindConfigPath);

// Dynamic import the config
const configModule = await import(`file://${tailwindConfigPath}`);
const tailwindConfig = configModule.default;

// Extract theme values
const colors = tailwindConfig.theme?.extend?.colors || {};
const spacing = tailwindConfig.theme?.extend?.spacing || {};
const fontSize = tailwindConfig.theme?.extend?.fontSize || {};
const borderRadius = tailwindConfig.theme?.extend?.borderRadius || {};
const maxWidth = tailwindConfig.theme?.extend?.maxWidth || {};
const fontFamily = tailwindConfig.theme?.extend?.fontFamily || {};

const loadWordPressPalette = () => {
  if (!existsSync(themeJsonPath)) {
    console.warn('‚ö†Ô∏è theme.json not found, skipping WordPress palette color utilities.');
    return [];
  }

  try {
    const theme = JSON.parse(readFileSync(themeJsonPath, 'utf-8'));
    const palette = theme.settings?.color?.palette || [];
    const customColors = theme.settings?.custom?.colors || {};

    const resolveColor = (value, depth = 0) => {
      if (!value || depth > 10) return null;

      const customMatch = value.match(/var\(--wp--custom--colors--([^)]+)\)/);
      if (customMatch) {
        const customValue = customColors[customMatch[1]];
        return resolveColor(customValue, depth + 1);
      }

      const presetMatch = value.match(/var\(--wp--preset--color--([^)]+)\)/);
      if (presetMatch) {
        const paletteColor = palette.find(({ slug }) => slug === presetMatch[1]);
        return resolveColor(paletteColor?.color, depth + 1);
      }

      return value;
    };

    return palette
      .map(({ slug, color }) => {
        const resolvedColor = resolveColor(color);
        return {
          slug,
          color: resolvedColor || color
        };
      })
      .filter(({ slug, color }) => Boolean(slug && color));
  } catch (error) {
    console.warn('‚ö†Ô∏è Could not parse theme.json palette:', error.message);
    return [];
  }
};

const paletteColors = loadWordPressPalette();

console.log('‚úÖ Loaded theme configuration');
console.log('   - Colors:', Object.keys(colors).join(', '));
console.log('   - Font sizes:', Object.keys(fontSize).join(', '));
console.log('   - Font families:', Object.keys(fontFamily).join(', '));
console.log('   - WordPress palette colors:', paletteColors.map(color => color.slug).join(', ') || 'none found');

const defaultColorUtilities = `
.wp-content .has-text-color {
  color: currentColor;
}

.wp-content .has-background {
  background-color: currentColor;
}
`.trim();

const paletteColorUtilities = paletteColors
  .map(({ slug, color }) => {
    const safeColor = typeof color === 'string' ? color.trim() : color;
    if (!safeColor) {
      return '';
    }
    return `
.wp-content .has-${slug}-color {
  color: ${safeColor};
}

.wp-content .has-${slug}-background-color {
  background-color: ${safeColor};
}

.wp-content .has-${slug}-border-color {
  border-color: ${safeColor};
}
`.trim();
  })
  .filter(Boolean)
  .join('\n\n');

const wpColorUtilities = [defaultColorUtilities, paletteColorUtilities].filter(Boolean).join('\n\n');

// Generate the CSS
const css = `/* 
 * WordPress Gutenberg Block Styles
 * Auto-generated from tailwind.config.js
 * 
 * DO NOT EDIT THIS FILE MANUALLY!
 * Run: npm run generate:wp-blocks
 * 
 * Generated: ${new Date().toISOString()}
 */

.wp-content {
  @apply text-neutral-600 leading-relaxed;
  ${fontFamily['open-sans'] ? `@apply font-open-sans;` : ''}
}

/* ============================================
   HEADINGS
   ============================================ */
.wp-content h1,
.wp-content .wp-block-heading:has(+ h1) {
  ${fontSize['heading-1'] ? `@apply text-heading-1;` : `@apply text-4xl;`}
  @apply text-neutral-700 font-semibold mt-8 mb-5;
}

.wp-content h2,
.wp-content .wp-block-heading {
  ${fontSize['heading-2'] ? `@apply text-heading-2;` : `@apply text-3xl;`}
  @apply text-neutral-700 font-semibold mt-8 mb-5;
}

.wp-content h3 {
  ${fontSize['heading-3'] ? `@apply text-heading-3;` : `@apply text-2xl;`}
  @apply text-neutral-700 font-semibold mt-7 mb-4;
}

.wp-content h4 {
  ${fontSize['heading-4'] ? `@apply text-heading-4;` : `@apply text-xl;`}
  @apply text-neutral-700 font-semibold mt-6 mb-4;
}

.wp-content h5 {
  ${fontSize['heading-5'] ? `@apply text-heading-5;` : `@apply text-lg;`}
  @apply text-neutral-700 font-semibold mt-5 mb-3;
}

.wp-content h6 {
  ${fontSize['heading-6'] ? `@apply text-heading-6;` : `@apply text-base;`}
  @apply text-neutral-700 font-semibold mt-4 mb-3;
}

/* ============================================
   TEXT CONTENT
   ============================================ */
.wp-content p {
  ${fontSize['medium'] ? `@apply text-medium;` : `@apply text-base;`}
  @apply text-neutral-500 mb-4 leading-relaxed;
}

.wp-content a {
  @apply text-secondary-400 hover:text-secondary-500 underline transition-colors;
}

.wp-content strong {
  @apply font-bold text-neutral-700;
}

.wp-content em {
  @apply italic;
}

.wp-content mark {
  @apply bg-secondary-200 text-neutral-700 px-1;
  ${borderRadius['small'] ? `@apply rounded-small;` : `@apply rounded;`}
}

/* ============================================
   BLOCKQUOTES
   ============================================ */
.wp-content blockquote,
.wp-content .wp-block-quote {
  @apply border-l-4 border-primary-400 pl-6 py-3 my-6 italic text-neutral-500 bg-primary-100;
  ${borderRadius['medium'] ? `@apply rounded-r-medium;` : `@apply rounded-r;`}
}

.wp-content blockquote p,
.wp-content .wp-block-quote p {
  ${fontSize['medium'] ? `@apply text-medium;` : `@apply text-base;`}
  @apply mb-2 last:mb-0;
}

.wp-content blockquote cite,
.wp-content .wp-block-quote cite {
  ${fontSize['small'] ? `@apply text-small;` : `@apply text-sm;`}
  @apply text-neutral-400 not-italic font-semibold;
}

.wp-content .wp-block-pullquote {
  @apply border-t-4 border-b-4 border-primary-400 py-8 my-8 text-center;
}

.wp-content .wp-block-pullquote blockquote {
  ${fontSize['x-large'] ? `@apply text-x-large;` : `@apply text-2xl;`}
  @apply text-neutral-700 font-semibold mb-4;
}

.wp-content .wp-block-pullquote cite {
  ${fontSize['small'] ? `@apply text-small;` : `@apply text-sm;`}
  @apply text-neutral-400;
}

/* ============================================
   LISTS
   ============================================ */
.wp-content ul,
.wp-content ol {
  @apply mb-5 pl-6 space-y-2;
}

.wp-content ul {
  @apply list-disc;
}

.wp-content ol {
  @apply list-decimal;
}

.wp-content li {
  ${fontSize['medium'] ? `@apply text-medium;` : `@apply text-base;`}
}

/* ============================================
   IMAGES
   ============================================ */
.wp-content img {
  ${borderRadius['large'] ? `@apply rounded-large;` : `@apply rounded-lg;`}
  @apply max-w-full h-auto my-6 shadow-sm;
}

.wp-content figure {
  @apply my-6;
}

.wp-content figcaption {
  ${fontSize['small'] ? `@apply text-small;` : `@apply text-sm;`}
  @apply text-neutral-400 mt-3 text-center;
}

.wp-content .wp-block-image {
  @apply my-6;
}

.wp-content .wp-block-image img {
  ${borderRadius['large'] ? `@apply rounded-large;` : `@apply rounded-lg;`}
}

/* ============================================
   GALLERY
   ============================================ */
.wp-content .wp-block-gallery {
  @apply grid gap-4 my-8;
}

.wp-content .wp-block-gallery.columns-2 {
  @apply grid-cols-2;
}

.wp-content .wp-block-gallery.columns-3 {
  @apply grid-cols-1 sm:grid-cols-2 lg:grid-cols-3;
}

.wp-content .wp-block-gallery.columns-4 {
  @apply grid-cols-2 lg:grid-cols-4;
}

.wp-content .wp-block-gallery figure {
  ${borderRadius['medium'] ? `@apply rounded-medium;` : `@apply rounded;`}
  @apply relative overflow-hidden;
}

.wp-content .wp-block-gallery img {
  @apply w-full h-full object-cover;
}

/* ============================================
   CODE
   ============================================ */
.wp-content code {
  ${borderRadius['small'] ? `@apply rounded-small;` : `@apply rounded;`}
  ${fontSize['small'] ? `@apply text-small;` : `@apply text-sm;`}
  @apply bg-neutral-200 text-neutral-700 px-2 py-1;
  ${fontFamily['monospace'] ? `@apply font-monospace;` : `@apply font-mono;`}
}

.wp-content pre {
  ${borderRadius['medium'] ? `@apply rounded-medium;` : `@apply rounded;`}
  @apply bg-neutral-700 text-neutral-0 p-6 overflow-x-auto my-6;
}

.wp-content pre code {
  @apply bg-transparent text-neutral-0 p-0;
}

/* ============================================
   TABLES
   ============================================ */
.wp-content table {
  @apply w-full border-collapse my-6;
}

.wp-content th {
  ${fontSize['small'] ? `@apply text-small;` : `@apply text-sm;`}
  @apply bg-neutral-200 font-semibold p-4 text-left border border-neutral-300 text-neutral-700;
}

.wp-content td {
  ${fontSize['medium'] ? `@apply text-medium;` : `@apply text-base;`}
  @apply p-4 border border-neutral-300 text-neutral-500;
}

.wp-content tbody tr:hover {
  @apply bg-neutral-100;
}

/* ============================================
   BUTTONS
   ============================================ */
.wp-content .wp-block-button {
  @apply my-5;
}

.wp-content .wp-block-button__link {
  ${borderRadius['medium'] ? `@apply rounded-medium;` : `@apply rounded;`}
  ${fontSize['medium'] ? `@apply text-medium;` : `@apply text-base;`}
  @apply inline-block px-6 py-3 bg-secondary-400 text-neutral-0 font-semibold no-underline hover:bg-secondary-500 transition-colors;
}

.wp-content .wp-block-button.is-style-outline .wp-block-button__link {
  @apply bg-transparent border-2 border-secondary-400 text-secondary-400 hover:bg-secondary-400 hover:text-neutral-0;
}

/* ============================================
   LAYOUT BLOCKS
   ============================================ */

/* Columns */
.wp-content .wp-block-columns {
  @apply grid gap-6 my-8;
}

.wp-content .wp-block-columns:has(.wp-block-column:nth-child(2):last-child) {
  @apply md:grid-cols-2;
}

.wp-content .wp-block-columns:has(.wp-block-column:nth-child(3):last-child) {
  @apply md:grid-cols-3;
}

.wp-content .wp-block-columns:has(.wp-block-column:nth-child(4):last-child) {
  @apply md:grid-cols-2 lg:grid-cols-4;
}

.wp-content .wp-block-column {
  @apply flex-1;
}

/* Cover Block */
.wp-content .wp-block-cover {
  ${borderRadius['large'] ? `@apply rounded-large;` : `@apply rounded-lg;`}
  @apply relative min-h-[400px] flex items-center justify-center text-neutral-0 overflow-hidden my-8;
  background-size: cover;
  background-position: center;
}

.wp-content .wp-block-cover.has-background-dim::before {
  content: '';
  @apply absolute inset-0 bg-neutral-700 opacity-50;
}

.wp-content .wp-block-cover__inner-container {
  ${maxWidth['content'] ? `@apply max-w-content;` : `@apply max-w-4xl;`}
  @apply relative z-10 w-full mx-auto px-6 text-center;
}

.wp-content .wp-block-cover h1,
.wp-content .wp-block-cover h2,
.wp-content .wp-block-cover h3 {
  @apply text-neutral-0;
}

/* Media & Text */
.wp-content .wp-block-media-text {
  @apply grid md:grid-cols-2 gap-8 items-center my-8;
}

.wp-content .wp-block-media-text__media {
  @apply w-full;
}

.wp-content .wp-block-media-text__media img {
  ${borderRadius['medium'] ? `@apply rounded-medium;` : `@apply rounded;`}
  @apply w-full h-full object-cover;
}

.wp-content .wp-block-media-text__content {
  @apply px-4;
}

/* Group Block */
.wp-content .wp-block-group {
  @apply my-8;
}

.wp-content .wp-block-group.has-background {
  ${borderRadius['medium'] ? `@apply rounded-medium;` : `@apply rounded;`}
  @apply p-8;
}

/* ============================================
   SEPARATORS
   ============================================ */
.wp-content hr,
.wp-content .wp-block-separator {
  @apply border-0 border-t-2 border-neutral-300 my-8;
}

.wp-content .wp-block-separator.is-style-wide {
  @apply w-full;
}

.wp-content .wp-block-separator.is-style-dots {
  @apply border-t-0;
  background: none;
  text-align: center;
}

.wp-content .wp-block-separator.is-style-dots::before {
  content: '¬∑¬∑¬∑';
  ${fontSize['x-large'] ? `@apply text-x-large;` : `@apply text-2xl;`}
  @apply text-neutral-400 tracking-widest;
}

/* Spacer Block */
.wp-content .wp-block-spacer {
  @apply clear-both;
}

/* ============================================
   MEDIA BLOCKS
   ============================================ */

/* Video & Audio */
.wp-content .wp-block-video,
.wp-content .wp-block-audio {
  @apply my-6;
}

.wp-content .wp-block-video video,
.wp-content .wp-block-audio audio {
  ${borderRadius['medium'] ? `@apply rounded-medium;` : `@apply rounded;`}
  @apply w-full;
}

/* Embeds */
.wp-content .wp-block-embed {
  @apply my-6;
}

.wp-content .wp-block-embed__wrapper {
  ${borderRadius['medium'] ? `@apply rounded-medium;` : `@apply rounded;`}
  @apply relative overflow-hidden;
  padding-bottom: 56.25%; /* 16:9 aspect ratio */
}

.wp-content .wp-block-embed__wrapper iframe {
  @apply absolute top-0 left-0 w-full h-full;
}

/* File Download */
.wp-content .wp-block-file {
  @apply my-6;
}

.wp-content .wp-block-file a {
  ${borderRadius['medium'] ? `@apply rounded-medium;` : `@apply rounded;`}
  @apply inline-flex items-center bg-neutral-200 hover:bg-neutral-300 px-4 py-3 no-underline text-neutral-700 transition-colors;
}

/* ============================================
   ALIGNMENT
   ============================================ */
.wp-content .alignleft {
  @apply float-left mr-6 mb-4;
  max-width: 50%;
}

.wp-content .alignright {
  @apply float-right ml-6 mb-4;
  max-width: 50%;
}

.wp-content .aligncenter {
  @apply mx-auto block text-center;
}

.wp-content .alignfull {
  @apply w-screen relative;
  left: 50%;
  right: 50%;
  margin-left: -50vw;
  margin-right: -50vw;
}

.wp-content .alignwide {
  ${maxWidth['wide'] ? `@apply max-w-wide;` : `@apply max-w-7xl;`}
  @apply mx-auto;
}

/* Clear floats */
.wp-content::after {
  content: '';
  display: table;
  clear: both;
}

/* ============================================
   TEXT ALIGNMENT
   ============================================ */
.wp-content .has-text-align-left {
  @apply text-left;
}

.wp-content .has-text-align-center {
  @apply text-center;
}

.wp-content .has-text-align-right {
  @apply text-right;
}

/* ============================================
   WORDPRESS COLOR CLASSES
   ============================================ */
${wpColorUtilities}
`;

// Write the file
const outputPath = resolve(__dirname, '../app/assets/css/wordpress-blocks.css');
writeFileSync(outputPath, css);

console.log('');
console.log('‚úÖ Generated wordpress-blocks.css successfully!');
console.log('üìÅ Output:', outputPath);
console.log('');
console.log('The file uses your custom theme from tailwind.config.js:');
console.log('  - Primary colors (red/orange accents)');
console.log('  - Secondary colors (purple for links/buttons)');
console.log('  - Neutral colors (grays for text)');
console.log('  - Fluid typography scales');
console.log('  - Custom spacing, border radius, and max widths');
console.log('');
console.log('üéâ Done! Your WordPress blocks will now match your theme.');
